<!DOCTYPE html>
<head>
    <title>
        WebGL Initial Cutoff Test
    </title>
</head>
<body bgColor="blue">
    <p id="delayText" style="color: #EFEFEF"></p>
</body>

<script src="../../bagel.js"></script>
<script>

const init = _ => {
    game = Bagel.init({
        id: "game",
        state: "game",
        vars: {
            speed: 15
        },
        game: {
            assets: {
                imgs: [
                    {
                        id: "Bagel",
                        src: "../../assets/imgs/bagel.png"
                    }
                ]
            },
            sprites: [
                {
                    id: "Missing",
                    img: ".Internal.missing",
                    scripts: {
                        init: [
                            {
                                code: null,
                                stateToRun: "game"
                            }
                        ],
                        main: [
                            {
                                code: me => {
                                    me.x += game.vars.speed;
                                },
                                stateToRun: "game"
                            }
                        ]
                    },
                    left: 0,
                    width: 100,
                    height: 100
                },
                {
                    id: "Bagel",
                    img: "Bagel",
                    scripts: {
                        init: [
                            {
                                code: null,
                                stateToRun: "game"
                            }
                        ],
                        main: [
                            {
                                code: me => {
                                    me.x += game.vars.speed;
                                },
                                stateToRun: "game"
                            }
                        ]
                    },
                    left: 0,
                    y: 330,
                    width: 100,
                    height: 100
                },
                {
                    id: "Canvas",
                    type: "canvas",
                    mode: "animated",
                    fullRes: false,
                    vars: {
                        animationTick: 0
                    },
                    scripts: {
                        init: [
                            {
                                code: me => {
                                    me.vars.img = game.get.asset.img("Bagel");
                                },
                                stateToRun: "game"
                            }
                        ],
                        main: [
                            {
                                code: me => {
                                    me.x += game.vars.speed;
                                },
                                stateToRun: "game"
                            }
                        ]
                    },
                    render: (me, game, ctx, canvas) => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(me.vars.img, 0, 0, canvas.width, canvas.height);

                        let y = me.vars.animationTick / 2;
                        ctx.fillRect(0, (canvas.height - y) - 1, canvas.width, y);

                        me.vars.animationTick++;
                    },
                    left: 0,
                    y: 120,
                    width: 100,
                    height: 100,
                },
                {
                    id: "Loading",
                    type: "canvas",
                    fullRes: false,
                    updateRes: false,
                    visible: false,
                    mode: "animated",
                    width: 1,
                    height: 1,
                    y: 400,
                    vars: {
                        angle: -90,
                        velocity: 0,
                        stage: 0,
                        delay: 0
                    },
                    scripts: {
                        init: [
                            {
                                code: (me, game) => {
                                    me.vars.img = Bagel.get.asset.img("Bagel");

                                    me.width = Math.max(game.width, game.height) / 5;
                                    me.height = me.width;
                                    me.canvas.width = me.vars.img.width;
                                    me.canvas.height = me.canvas.width;

                                    me.left = 0;
                                    //document.body.appendChild(me.canvas);
                                },
                                stateToRun: "game"
                            }
                        ],
                        main: [
                            {
                                code: (me, game) => {
                                    if (! me.visible) {
                                        me.vars.delay++;
                                        if (me.vars.delay == 10) {

                                        }
                                    }

                                    me.x += game.vars.speed;
                                },
                                stateToRun: "game"
                            }
                        ]
                    },
                    render: (me, game, ctx, canvas) => {
                        let img = me.vars.img;
                        let midPoint = canvas.width / 2;

                        ctx.imageSmoothingEnabled = false;
                        ctx.fillStyle = game.config.display.backgroundColor;

                        if (me.vars.stage == 0) {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);

                            if (me.vars.angle != -90) {
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            }
                            let maxAngle = ((100 / 100) * 360) - 90;
                            if (maxAngle > me.vars.angle) {
                                me.vars.velocity += 5; // 5
                                me.vars.angle += me.vars.velocity;
                                me.vars.velocity *= 0.9;
                                if (maxAngle <= me.vars.angle) {
                                    me.vars.velocity = 0;
                                    me.vars.angle = maxAngle;
                                }
                            }
                            if (100 == 100 && me.vars.velocity == 0) {
                                me.vars.stage++;
                                return;
                            }

                            ctx.beginPath();
                            ctx.moveTo(midPoint, midPoint);
                            ctx.arc(midPoint, midPoint, midPoint * 2, Bagel.maths.degToRad(-90), Bagel.maths.degToRad(me.vars.angle), true);
                            ctx.lineTo(midPoint, midPoint);
                            ctx.fill();

                            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset the scaling
                        }
                        else {
                            me.vars.velocity += 1;
                            me.width -= me.vars.velocity;
                            me.height -= me.vars.velocity;
                            me.vars.velocity *= 0.9;

                            if (me.width <= 1) {
                                me.visible = false;
                            }
                            return true;
                        }
                    }
                }
            ]
        },
        width: 800,
        height: 450,
        config: {
            loading: {
                mode: "preload"
            },
            display: {
                renderer: "webgl"
            }
        }
    });
};

const delayText = document.querySelector("#delayText");
if (location.hash == "#wait") {
    delayText.innerHTML = "Delay active, the animation should no longer be cut off";
    setTimeout(_ => {
        init();
    }, 1000);
}
else {
    delayText.innerHTML = "Delay off, the animation might be cut off in Chrome";
    init();
}

</script>
